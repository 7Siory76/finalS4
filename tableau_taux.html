<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestion des prêts</title>
    <style>
        :root {
            --primary-color: #1a3a1a; /* Vert foncé */
            --secondary-color: #000000; /* Noir */
            --accent-color: hsl(120, 36%, 26%); /* Vert un peu plus clair */
            --light-bg: #f5f5f5; /* Fond clair */
            --hover-color: #3a7a3a; /* Vert plus vif pour les hover */
            --error-color: #f44336;
            --border-radius: 8px;
            --transition-speed: 0.3s;
            --box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--light-bg);
            margin: 0;
            padding: 2rem;
            color: var(--secondary-color);
            line-height: 1.6;
        }
        
        h1 {
            color: var(--primary-color);
            text-align: center;
            margin-bottom: 2rem;
            font-size: 2rem;
        }
        
        h2 {
            color: var(--primary-color);
            margin-top: 0;
        }
        
        #tauxForm {
            background-color: white;
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            max-width: 800px;
            margin: 0 auto 2rem;
        }
        
        .form-group {
            margin-bottom: 1.5rem;
        }
        
        label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary-color);
        }
        
        select {
            width: 100%;
            padding: 0.8rem 1rem;
            border: 2px solid #ddd;
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: all var(--transition-speed);
            background-color: #f9f9f9;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='currentColor' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6 9 12 15 18 9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 1rem center;
            background-size: 1em;
        }
        
        select:focus {
            border-color: var(--accent-color);
            outline: none;
            box-shadow: 0 0 0 3px rgba(42, 90, 42, 0.2);
            background-color: white;
        }
        
        button {
            background-color: var(--primary-color);
            color: white;
            padding: 0.9rem 1.8rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-speed);
            width: 100%;
            margin-top: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        button:hover {
            background-color: var(--hover-color);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
        }
        
        button:active {
            transform: translateY(0);
        }
        
        .error {
            color: var(--error-color);
            font-weight: 500;
            padding: 0.5rem 0;
        }
        
        #resultats {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        .results-container {
            display: flex;
            flex-wrap: wrap;
            gap: 2rem;
            margin-top: 2rem;
        }
        
        .table-container {
            flex: 1;
            min-width: 300px;
            background-color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 1rem;
        }
        
        th, td {
            padding: 1rem;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        
        tr:hover {
            background-color: #f1f1f1;
        }
        
        .chart-container {
            flex: 2;
            min-width: 300px;
            background-color: white;
            padding: 1.5rem;
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
        }
        
        @media (max-width: 768px) {
            body {
                padding: 1rem;
            }
            
            #tauxForm {
                padding: 1.5rem;
            }
            
            .results-container {
                flex-direction: column;
            }
            
            .table-container, .chart-container {
                width: 100%;
            }
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
    <h1>Consultation des taux de prêt gagnés</h1>
    
    <form id="tauxForm">
        <div class="form-group">
            <label for="moisDebut">Mois début:</label>
            <select id="moisDebut" name="moisDebut" required>
                <option value="">-- Sélectionnez --</option>
                <option value="01">Janvier</option>
                <option value="02">Février</option>
                <option value="03">Mars</option>
                <option value="04">Avril</option>
                <option value="05">Mai</option>
                <option value="06">Juin</option>
                <option value="07">Juillet</option>
                <option value="08">Août</option>
                <option value="09">Septembre</option>
                <option value="10">Octobre</option>
                <option value="11">Novembre</option>
                <option value="12">Décembre</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="anneeDebut">Année début:</label>
            <select id="anneeDebut" name="anneeDebut" required>
                <option value="">-- Sélectionnez --</option>
                <!-- Les options seront générées par JavaScript -->
            </select>
        </div>
        
        <div class="form-group">
            <label for="moisFin">Mois fin:</label>
            <select id="moisFin" name="moisFin" required>
                <option value="">-- Sélectionnez --</option>
                <option value="01">Janvier</option>
                <option value="02">Février</option>
                <option value="03">Mars</option>
                <option value="04">Avril</option>
                <option value="05">Mai</option>
                <option value="06">Juin</option>
                <option value="07">Juillet</option>
                <option value="08">Août</option>
                <option value="09">Septembre</option>
                <option value="10">Octobre</option>
                <option value="11">Novembre</option>
                <option value="12">Décembre</option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="anneeFin">Année fin:</label>
            <select id="anneeFin" name="anneeFin" required>
                <option value="">-- Sélectionnez --</option>
            </select>
        </div>
        
        <button type="submit">Rechercher</button>
    </form>
    
    <div id="resultats"></div>

    <script>
        const apiBase = 'http://localhost/finalS4/ws'; 
        let chartInstance = null; // Pour stocker l'instance du graphique
        
        function ajax(method, url, data, callback) {
            const xhr = new XMLHttpRequest();
            xhr.open(method, apiBase + url, true);
            xhr.setRequestHeader("Accept", "application/json");
            
            xhr.onload = function() {
                try {
                    const response = xhr.responseText ? JSON.parse(xhr.responseText) : null;
                    callback(response);
                } catch (e) {
                    console.error("Erreur de parsing JSON:", e, "Réponse:", xhr.responseText);
                    callback({
                        error: `Réponse serveur invalide: ${xhr.responseText.substring(0, 100)}`
                    });
                }
            };
            
            xhr.onerror = function() {
                callback({ error: "Erreur réseau" });
            };
            
            xhr.send(data);
        }

        document.addEventListener('DOMContentLoaded', function() {
            const currentYear = new Date().getFullYear();
            const anneeDebutSelect = document.getElementById('anneeDebut');
            const anneeFinSelect = document.getElementById('anneeFin');
            
            for (let y = currentYear - 10; y <= currentYear + 10; y++) {
                const option = document.createElement('option');
                option.value = y;
                option.textContent = y;
                anneeDebutSelect.appendChild(option.cloneNode(true));
                anneeFinSelect.appendChild(option);
            }
            
            document.getElementById('tauxForm').addEventListener('submit', function(e) {
                e.preventDefault();
                getTaux();
            });
        });
        
        function getTaux() {
            const moisDebut = document.getElementById('moisDebut').value;
            const anneeDebut = document.getElementById('anneeDebut').value;
            const moisFin = document.getElementById('moisFin').value;
            const anneeFin = document.getElementById('anneeFin').value;
            
            if (!moisDebut || !anneeDebut || !moisFin || !anneeFin) {
                document.getElementById('resultats').innerHTML = 
                    '<p class="error">Veuillez remplir tous les champs</p>';
                return;
            }
            
            const dateDebut = new Date(`${anneeDebut}-${moisDebut}-01`);
            const dateFin = new Date(`${anneeFin}-${moisFin}-01`);
            
            if (dateFin < dateDebut) {
                document.getElementById('resultats').innerHTML = 
                    '<p class="error">La date de fin doit être postérieure ou égale à la date de début</p>';
                return;
            }
            
            const data = `moisDebut=${encodeURIComponent(moisDebut)}` +
                         `&anneeDebut=${encodeURIComponent(anneeDebut)}` +
                         `&moisFin=${encodeURIComponent(moisFin)}` +
                         `&anneeFin=${encodeURIComponent(anneeFin)}`;
            
            ajax('GET', '/pret/taux?' + data, null, function(response) {
                const resultDiv = document.getElementById('resultats');
                
                if (response.error) {
                    resultDiv.innerHTML = `<p class="error">${response.error}</p>`;
                } else if (response.message) {
                    resultDiv.innerHTML = `<p>${response.message}</p>`;
                } else {
                    let html = '<h2>Résultats</h2>';
                    html += '<div class="results-container">';
                    
                    if (Array.isArray(response) && response.length > 0) {
                        // Création du tableau
                        html += '<div class="table-container">';
                        html += '<table>';
                        html += '<thead><tr><th>Période</th><th>Montant</th></tr></thead>';
                        html += '<tbody>';
                        
                        response.forEach(item => {
                            html += `<tr>
                                <td>${item.mois}/${item.annee}</td>
                                <td>${Number(item.total_par_mois).toLocaleString()} Ar</td>
                            </tr>`;
                        });
                        
                        html += '</tbody></table></div>';
                        
                        // Création du canvas pour le graphique
                        html += '<div class="chart-container">';
                        html += '<canvas id="tauxChart"></canvas>';
                        html += '</div>';
                        
                        html += '</div>'; // Fermeture de results-container
                        
                        resultDiv.innerHTML = html;
                        
                        // Générer le graphique
                        createChart(response);
                    } else {
                        html += '<p>Aucun résultat trouvé</p>';
                        resultDiv.innerHTML = html;
                    }
                }
            });
        }
        
        function createChart(data) {
            if (chartInstance) {
                chartInstance.destroy();
            }
            
            const ctx = document.getElementById('tauxChart').getContext('2d');
            
            const labels = data.map(item => `${item.mois}/${item.annee}`);
            const amounts = data.map(item => item.total_par_mois);
            
            chartInstance = new Chart(ctx, {
                type: 'bar', 
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Montant des prêts (Ar)',
                        data: amounts,
                        backgroundColor: 'rgba(26, 58, 26, 0.7)',
                        borderColor: 'rgba(26, 58, 26, 1)',
                        borderWidth: 1,
                        hoverBackgroundColor: 'rgba(58, 122, 58, 0.8)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Évolution des montants de prêts',
                            font: {
                                size: 16
                            }
                        },
                        legend: {
                            position: 'top',
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return context.parsed.y.toLocaleString() + ' Ar';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value.toLocaleString() + ' Ar';
                                }
                            },
                            grid: {
                                color: 'rgba(0, 0, 0, 0.05)'
                            }
                        },
                        x: {
                            grid: {
                                display: false
                            }
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>